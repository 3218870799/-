容灾架构的目标尽可能的保证SLA：

三个准则：面向故障设计/墨菲定律/自动化

只要运行时间足够长，数据量足够大，BUG肯定会出现



SLA/SLI/SLO

1：SLI 服务等级指标， 用来衡量系统的可靠性，成功了QPS/服务停机时长；

2：SLO 服务等级目标，

3：SLA 服务登记协议，当SLI无法满足SLO时没需要进行的赔偿标准；



强弱/核心，非核心依赖：

1：强依赖 依赖失败，用户会立即感知，SLI会直接波动，导致低于SLO；

2：弱依赖 依赖失败，用户不会立即感知，SLI不受影响

3：核心依赖 失败，用户不会立即感知，但SLI会有波动

4：非核心依赖 失败， 用户不会感知，SLI也不会波动；

高可用系统不应该存在强依赖，而应该通过架构技术将强依赖转换成核心依赖；



并发/吞吐/延迟



SRE ：网站可靠性工程师；

DevOps：基于敏捷开发的思想，



# 容灾稳定性：

基于核心场景的核心链路来建设容灾能力；

## 故障复盘

事后处理

事务总结模板

```txt
1．事故的基本信息:开始时间，发现时间，止损时间，修复时间，发现渠道，责任人。
2．事故的影响范围:请求数量，用户数量，故障时长，核心业务指标，产品形象。
3．事故的处理过程:根据聊天记录，平台操作记录，逐步恢复当时处理过程的时间线。
4．事故的直接原因:定位到直接造成事故的变更操作行为及人。
5．事故的根本原因:
    a.为什么要做这个变更?不做不行吗?
    b.编码环节为什么没有保证逻辑鲁棒性?c．测试验收环节为什么没发现问题?
    d.上线方案为什么没有避免这个问题?
    e.为什么监控报警没有发现问题?
6．事故的改进计划:基于上述五个关键节点增加改进计划，对事不对人
系统自动化>工具自动化>流程机制>奖惩机制>行为规范>思想规范
```

## 故障发现

依赖治理：核心链路场景发现与治理；

指标&报警&日志 的建设

指标：

```txt
外部视角的指标建设:
1．先定义SL,以用户视角定义合理的指标，指标应该是强置信的，其次才是可统计的，再次考虑信噪比
2．根据SLI的摸底基线，与业务视角的期望定义合理的SLO，考虑稳定性的优化成本，以满足业务为准
3．基于SLO确认，当SLI不足SLO时的赔偿方案，并落地为协议，作为最终标准。
内部视角的指标建设:
1．以发现问题为目标，以调用方视角正确处理下游依赖所有的errcode情况。
2.核心链路上的核心逻辑分支需要有事件性指标。
3.指标的key最好体现在对应的日志中，这样在看到指标后可以通过日志的关键词搜索快速的定位问题
```

报警：

明确优先级，必须要有明确的处理方案；

报警召回率 =  1-无效报警/总报警；

日志：

日志级别；日志必须携带上下文信息看到日志即可定位，链路跟踪/基本信息；

## 故障止损

止损大于发现问题原因：

降级预案：

对于线上的所有变更，都必须具有回滚方案，且能快速回滚。

核心依赖，都必须存在兜底逻辑；

针对不同场景，降级原必须定期演练

```txt
a，超时(核心依赖1-3倍p99.5;非核心依赖1-2倍的p99.5)
b.重试(核心1次重试+10%比例;非核心0次)
c．熔断(防止无效等待,占用资源,保护下游)
d.兜底(冗余策略尽可能的降低用户体验)
e.切流(方式:比例/正则backup:服务/机房)
```

## 故障修复

错误日志；变更日志；上线分析；

系统自愈；

## 故障预防

编码:单一，隔离，异常处理，防御性编程(依赖/使用方/自己)

上线:双人review，灰度机制，上线检测(错误日志，流量正常，核心指标，机器负载，报警，回归)

单点:保证核心点的冗余

容量:50%冗余原则

演练:混沌工程 

