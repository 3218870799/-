最近系统中在做一个统计公司规模的功能，

系统中公司下某客户通过某种渠道的份额并不是一直都有的，净值按理来说是每天都有，但是也可能出现某个产品

在统计的时候，需要获取最新的份额去乘以最新的净值，统计一年的话，数据量就是

份额量=2万客户，500产品 ，100左右代销渠道，

净值：500产品

再乘以365；

如果没有中间表，这个量在进行连接时然后在数据库文档进行Group by 然后再回表查询出来，耗时一在5分钟左右；一旦超过设置的超时时间，就直接报连接超时；

方案一：

补全每天的份额表：如果补全，数据量过大，对其他的操作可能会影响；

方案二：

定时任务：但是净值和份额是支持修改历史数据的，定时任务满足不了条件

方案三：

触发器：当修改份额表或净值表时，触发任务进行重算，这种会严重插入的性能；

方案四：

异步监听份额表和净值表的binlog日志，然后插入中间表，保存最大最新的份额日期，然后消息队列异步会写中间表；

当中间表进行修改后，然后再进行重算规模和客户统计表；页面查询统计时直接取这张表中的数据即可。

发现系统中很多地方查询最新的净值日期和最新的份额时数据时都是使用内连接查询，先查最新的日期，然后再反关联当前表再去查到最新的那一条记录；于是决定采用方案四，虽然改动会比较大，但是可以慢慢改，不会影响，对系统的提升有着较好的效果；

